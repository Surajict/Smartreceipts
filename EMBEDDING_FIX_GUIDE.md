# Fix Smart Search Embeddings - Complete Guide

## Problem Summary
The embedding column in the receipts table is showing as NULL, which means Smart Search functionality isn't working. This is because the database trigger approach was failing.

## Solution Overview
I've created a more reliable approach using Edge Functions instead of database triggers.

---

## Step 1: Run Diagnostic Script

First, let's see what's happening. Go to your **Supabase Dashboard** → **Database** → **SQL Editor** and run:

```sql
/*
  # Diagnostic Script for Embedding Issues
  
  This script will help us understand what's happening with embeddings
*/

-- Check if the trigger exists
SELECT 
  trigger_name,
  event_manipulation,
  action_statement,
  action_timing
FROM information_schema.triggers 
WHERE trigger_name = 'trigger_generate_receipt_embedding';

-- Check if the function exists
SELECT 
  routine_name,
  routine_type,
  data_type
FROM information_schema.routines 
WHERE routine_name = 'generate_receipt_embedding';

-- Check if pgvector extension is enabled
SELECT 
  extname,
  extversion
FROM pg_extension 
WHERE extname = 'vector';

-- Check if we have any receipts with embeddings
SELECT 
  COUNT(*) as total_receipts,
  COUNT(embedding) as receipts_with_embeddings,
  COUNT(*) - COUNT(embedding) as receipts_without_embeddings
FROM receipts;

-- Check if Supabase AI functions are available
SELECT 
  routine_name
FROM information_schema.routines 
WHERE routine_name LIKE '%openai%' OR routine_name LIKE '%embed%';

-- Test a simple embedding generation (this will fail if AI isn't available)
DO $$
DECLARE
  test_embedding vector(384);
BEGIN
  BEGIN
    SELECT ai.openai_embed(
      'text-embedding-3-small',
      'test text',
      dimensions => 384
    ) INTO test_embedding;
    
    RAISE NOTICE 'Supabase AI is working! Test embedding generated successfully.';
  EXCEPTION WHEN OTHERS THEN
    RAISE NOTICE 'Supabase AI is not available: %', SQLERRM;
  END;
END $$;
```

---

## Step 2: Clean Up and Remove Problematic Trigger

Run this SQL to remove the broken trigger:

```sql
/*
  # Remove Database Trigger and Use Edge Function Approach
  
  1. Remove the problematic database trigger
  2. Clean up functions that don't work
  3. Use edge functions for embedding generation instead
*/

-- Remove the trigger that's causing issues
DROP TRIGGER IF EXISTS trigger_generate_receipt_embedding ON receipts;

-- Remove the functions that aren't working
DROP FUNCTION IF EXISTS generate_receipt_embedding();
DROP FUNCTION IF EXISTS backfill_receipt_embeddings();

-- Create a simple function to check embedding status
CREATE OR REPLACE FUNCTION get_embedding_status()
RETURNS TABLE (
  total_receipts bigint,
  receipts_with_embeddings bigint,
  receipts_without_embeddings bigint
) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    COUNT(*) as total_receipts,
    COUNT(embedding) as receipts_with_embeddings,
    COUNT(*) - COUNT(embedding) as receipts_without_embeddings
  FROM receipts;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION get_embedding_status() TO authenticated;

-- Add a comment explaining the new approach
COMMENT ON COLUMN receipts.embedding IS 'Vector embedding generated by edge function for semantic search';

-- Create an index on the embedding column if it doesn't exist
CREATE INDEX IF NOT EXISTS receipts_embedding_idx ON receipts USING ivfflat (embedding vector_cosine_ops);

-- Add a helpful view for debugging
CREATE OR REPLACE VIEW receipt_embedding_status AS
SELECT 
  id,
  product_description,
  brand_name,
  CASE 
    WHEN embedding IS NOT NULL THEN 'Has Embedding'
    ELSE 'Missing Embedding'
  END as embedding_status,
  created_at
FROM receipts
ORDER BY created_at DESC;
```

---

## Step 3: Deploy Edge Functions

### Option A: If you have Supabase CLI installed:

```bash
cd /home/biswan02/Smart_Receipts_Suraj_V5/Smartreceipts
supabase functions deploy generate-embedding
supabase functions deploy backfill-embeddings
```

### Option B: Manual deployment via Supabase Dashboard:

1. Go to **Edge Functions** in your Supabase dashboard
2. Create a new function called `generate-embedding`
3. Copy the code from `supabase/functions/generate-embedding/index.ts`
4. Deploy it
5. Repeat for `backfill-embeddings`

---

## Step 4: Set Up Environment Variables

In your Supabase project, go to **Settings** → **Edge Functions** and add:

```
OPENAI_API_KEY=your_openai_api_key_here
```

(This is a fallback in case Supabase AI isn't available)

---

## Step 5: Test the New System

### Test 1: Check Embedding Status

In your browser console (F12), run:

```javascript
// Test the embedding status function
const response = await fetch('/api/embedding-status');
console.log(await response.json());
```

### Test 2: Generate Embedding for a Test Receipt

Create a test receipt and check if it gets an embedding automatically.

### Test 3: Backfill Existing Receipts

In your browser console:

```javascript
// Backfill embeddings for existing receipts
const userId = 'your-user-id'; // Get this from your user session
const response = await fetch(`${import.meta.env.VITE_SUPABASE_URL}/functions/v1/backfill-embeddings`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${import.meta.env.VITE_SUPABASE_ANON_KEY}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    userId: userId,
    batchSize: 5
  })
});

console.log(await response.json());
```

---

## Step 6: Verify Smart Search is Working

1. Go to your app: http://localhost:5174/
2. Try the Smart Search with queries like:
   - "laptop computer"
   - "phone charger"  
   - Brand names or store names
3. You should see results with relevance scores

---

## Troubleshooting

### If embeddings are still NULL:

1. **Check Edge Function Logs**: Go to Supabase Dashboard → Edge Functions → Logs
2. **Check if OpenAI API key is set**: Verify in Edge Functions settings
3. **Test manually**: Use the browser console tests above

### If Smart Search returns no results:

1. **Check if receipts have embeddings**: Run `SELECT COUNT(embedding) FROM receipts;`
2. **Check the search function**: Look at browser console for errors
3. **Verify the search endpoint**: Make sure the smart-search function is deployed

### If you get CORS errors:

Make sure all edge functions have the correct CORS headers (they should already be included).

---

## What This New Approach Does

✅ **Reliable Embedding Generation**: Uses Edge Functions instead of database triggers  
✅ **Better Error Handling**: You can see errors in the browser console  
✅ **Flexible AI Provider**: Falls back to OpenAI API if Supabase AI isn't available  
✅ **Manual Control**: You can generate embeddings on-demand  
✅ **Batch Processing**: Can backfill multiple receipts at once  
✅ **Easy Debugging**: Clear logging and status checking  

This approach is much more reliable than database triggers and gives you full control over the embedding generation process! 